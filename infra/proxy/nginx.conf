# Nginx 역방향 프록시 설정: 외부 요청을 내부 서비스(front, api, geo)로 라우팅
# (이 파일은 Nginx 설정의 일부이며, http 블록 내부에 위치함)

  # --- 1. 업스트림(Upstream) 정의 ---
  # '업스트림': Nginx가 요청을 전달할 내부 서버(컨테이너)들의 그룹
  # 도커 컴포즈 환경이므로 IP가 아닌 '서비스 이름'을 사용

  # 1-1. 'front' 업스트림: React 프론트엔드 서버 (cityrun-front 컨테이너)
  upstream front { server cityrun-front:80; }
  # 1-2. 'api' 업스트림: Spring Boot 백엔드 서버 (cityrun-api 컨테이너)
  upstream api   { server cityrun-api:8080; }
  # 1-3. 'geo' 업스트림: Node.js 지리정보 서버 (cityrun-geo 컨테이너)
  upstream geo   { server cityrun-geo:3000; }

  # --- 2. HTTP(80) -> HTTPS(443) 강제 리다이렉트 서버 ---
  # HTTP(80번 포트) 접속 시, 보안을 위해 HTTPS(443번 포트)로 자동 전환
  server {
    listen 80; # 80번 포트에서 수신
    server_name _; # 모든 도메인 요청에 대해 적용
    
    # 301 영구 리다이렉트 응답 전송
    # 예: http://cityrun.com/page -> https://cityrun.com/page
    return 301 https://$host$request_uri;
  }

  # --- 3. 메인 HTTPS(443) 서버 (SSL/TLS 종료 지점) ---
  server {
    listen 443 ssl; # 443번 포트에서 SSL 암호화된 요청 수신
    server_name _; # 모든 도메인 요청에 대해 적용

    # SSL 인증서 파일 경로 (컨테이너 내부 경로)
    ssl_certificate /etc/nginx/certs/cityrun.crt;
    # SSL 개인 키 파일 경로 (컨테이너 내부 경로)
    ssl_certificate_key /etc/nginx/certs/cityrun.key;

    # --- 3-1. 라우팅 규칙 (Location) ---

    # (A) 루트 경로 ('/'): 기본 요청은 'front' 업스트림(React 앱)으로 전달
    location / {
      proxy_pass http://front;
    }
    
    # (B) '/api/' 경로: /api/로 시작하는 모든 요청은 'api' 업스트림(Spring Boot)으로 전달
    # 예: /api/users/me -> http://cityrun-api:8080/api/users/me
    location /api/ {
      proxy_pass http://api;
    }
    
    # (C) '/geo/' 경로: /geo/로 시작하는 요청은 'geo' 업스트림(Node.js)으로 전달
    location /geo/ {
      # /geo/score-route -> /score-route로 경로 재작성
      # (Node.js 서버는 /geo/ 접두사 없이 요청을 받음)
      rewrite ^/geo/(.*)$ /$1 break;
      proxy_pass http://geo;
    }

    # --- 3-2. 프록시 헤더 설정 ---
    # 내부 서버로 원본 요청의 정보를 전달하기 위한 헤더 설정

    # Host 헤더를 원본 요청의 호스트로 설정
    proxy_set_header Host $host;
    # X-Real-IP 헤더에 실제 클라이언트의 IP 주소 설정
    proxy_set_header X-Real-IP $remote_addr;
    # X-Forwarded-For 헤더에 프록시를 거친 IP 주소들 설정
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    # X-Forwarded-Proto 헤더에 원본 프로토콜(https) 설정
    # (내부 서버가 이 요청이 HTTPS였음을 인지하도록 함)
    proxy_set_header X-Forwarded-Proto https;
  }