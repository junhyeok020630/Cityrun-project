# Nginx 역방향 프록시 설정: 외부 요청을 내부 서비스(front, api, geo)로 라우팅
user nginx;
worker_processes auto;

events {
    worker_connections 1024;
}

http {
    # --- 1. 업스트림(Upstream) 정의 ---
    # 도커 컴포즈 서비스 이름을 사용하여 내부 컨테이너의 주소를 지정
    upstream front { server cityrun-front:80; }
    upstream api   { server cityrun-api:8080; }
    upstream geo   { server cityrun-geo:3000; }

    # --- 2. HTTP(80) -> HTTPS(443) 강제 리다이렉트 서버 ---
    server {
        listen 80;
        server_name _;
        return 301 https://$host$request_uri;
    }

    # --- 3. 메인 HTTPS(443) 서버 (SSL/TLS 종료 지점) ---
    server {
        listen 443 ssl;
        server_name _;

        # SSL 인증서 파일 경로
        ssl_certificate /etc/nginx/certs/cityrun.crt;
        ssl_certificate_key /etc/nginx/certs/cityrun.key;

        # (A) 루트 경로: React 프론트엔드로 전달
        location / {
            proxy_pass http://front;
        }
        # (B) /api/ 경로: Spring Boot API 서버로 전달
        location /api/ {
            proxy_pass http://api;
        }
        # (C) /geo/ 경로: Node.js Geo 엔진 서버로 전달 (경로 재작성 포함)
        location /geo/ {
            rewrite ^/geo/(.*)$ /$1 break; # /geo/ 접두사 제거
            proxy_pass http://geo;
        }

        # 프록시 헤더 설정 (내부 서버가 원본 클라이언트 정보를 알 수 있도록 함)
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
    }
}